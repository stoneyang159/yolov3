[toc]

# 预训练模型推理和测试

## 推理

利用pretrained model进行推理，结果生成在output文件夹

```shell
python3 detect.py --image_folder images/
```

![2020-08-24 09-36-45 的屏幕截图](/home/lhw/Pictures/2020-08-24 09-36-45 的屏幕截图.png)

![1_Handshaking_Handshaking_1_35](/home/lhw/workspace/yz/yolov3/output/1_Handshaking_Handshaking_1_35.png)

![1_Handshaking_Handshaking_1_42](/home/lhw/workspace/yz/yolov3/output/1_Handshaking_Handshaking_1_42.png)

![1_Handshaking_Handshaking_1_46](/home/lhw/workspace/yz/yolov3/output/1_Handshaking_Handshaking_1_46.png)

![1_Handshaking_Handshaking_1_59](/home/lhw/workspace/yz/yolov3/output/1_Handshaking_Handshaking_1_59.png)

![1_Handshaking_Handshaking_1_61](/home/lhw/workspace/yz/yolov3/output/1_Handshaking_Handshaking_1_61.png)

## 测试

```python
 python3 test.py --weights_path weights/yolov3.weights
```

![2020-08-24 09-45-29 的屏幕截图](/home/lhw/Pictures/2020-08-24 09-45-29 的屏幕截图.png)

![2020-08-24 09-45-38 的屏幕截图](/home/lhw/Pictures/2020-08-24 09-45-38 的屏幕截图.png)



# coco数据集训练

利用imagenet预训练权重能加快收敛速度：

```shell
python3 train.py --data_config config/coco.data --model_def config/yolov3.cfg --pretrained_weights weights/darknet53.conv.74
```

## 遇到的问题

### AttributeError: module 'tensorflow' has no attribute 'Summary'

解决方案，tensorflow降级至1.13.1

### torch.uint8类型被弃用引发的警告

警告如下，它会影响训练过程中log的观察

[W IndexingUtils.h:20] Warning: indexing with dtype torch.uint8 is now deprecated, please use a dtype torch.bool instead. (function expandTensors)

解决方法：

打开models.py,找到如下代码段：

```python
iou_scores, class_mask, obj_mask, noobj_mask, tx, ty, tw, th, tcls, tconf = build_targets(
    pred_boxes=pred_boxes,              # (b, 3, 13, 13, 4)
    pred_cls=pred_cls,                  # (b, 3, 13, 13, 80)
    target=targets,                     # (n_boxes, 6) [details in build_targets function]
    anchors=self.scaled_anchors,        # (3, 2) 3个anchor，每个2维
    ignore_thres=self.ignore_thres,     # 0.5 (hard code in YOLOLayer self.init())
)
```

后面添加：

```python
obj_mask = obj_mask.bool()
noobj_mask = noobj_mask.bool()
```



## 训练过程可视化

![2020-08-24 09-55-50 的屏幕截图](/home/lhw/Pictures/2020-08-24 09-55-50 的屏幕截图.png)



#### tensorboard

项目根目录执行：

```shell
tensorboard --logdir='logs' --port=6006
```

打开浏览器，输入[host_name]:6006

![2020-08-24 09-58-03 的屏幕截图](/home/lhw/Pictures/2020-08-24 09-58-03 的屏幕截图.png)



# mask 数据集训练

